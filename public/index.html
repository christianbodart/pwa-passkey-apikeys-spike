<!DOCTYPE html>
<html>
<head>
  <title>Iframe WebAuthn Test</title>
  <style>
    body { font-family: system-ui; padding: 2rem; margin: 0; }
    iframe { 
      width: 100%; 
      height: 400px; 
      border: 2px solid #ccc; 
      border-radius: 8px; 
      margin: 1rem 0;
    }
    pre { background: #f5f5f5; padding: 1rem; border-radius: 4px; }
    .status { margin: 1rem 0; padding: 1rem; border-radius: 4px; }
    .green { background: #d4edda; border-left: 4px solid #28a745; }
    .yellow { background: #fff3cd; border-left: 4px solid #ffc107; }
    .red { background: #f8d7da; border-left: 4px solid #dc3545; }
  </style>
</head>
<body>
  <h1>üß™ WebAuthn Iframe Fallback Test</h1>
  
  <h2>Parent Page (Main)</h2>
  <div id="parent-status" class="status">Loading...</div>
  
  <h2>Iframe (Auth Target)</h2>
  <iframe 
    id="auth-iframe" 
    src="./iframe-test.html"
    sandbox="allow-scripts allow-same-origin allow-top-navigation"
    loading="lazy"
  ></iframe>
  
  <h2>Communication Log</h2>
  <pre id="messages">No messages yet</pre>
  
  <script>
    // Parent page capability detection
    async function detectCapabilities() {
      const caps = {
        webauthn: !!window.PublicKeyCredential,
        subtleCrypto: !!window.crypto?.subtle,
        postMessage: !!window.postMessage,
        visibilityApi: !!document.visibilityState,
        timestamp: Date.now()
      };
      
      const statusEl = document.getElementById('parent-status');
      const className = caps.webauthn ? 'green' : 'red';
      statusEl.className = `status ${className}`;
      statusEl.innerHTML = `
        <h3>Parent Capabilities</h3>
        <pre>${JSON.stringify(caps, null, 2)}</pre>
        <p><strong>Status: ${caps.webauthn ? '‚úÖ WebAuthn Ready' : '‚ùå Fallback Needed'}</strong></p>
      `;
      
      return caps;
    }
    
    // Message handling
    window.addEventListener('message', (event) => {
      const logEl = document.getElementById('messages');
      const messages = JSON.parse(logEl.textContent === 'No messages yet' ? '[]' : logEl.textContent);
      messages.unshift({
        time: new Date().toISOString(),
        source: event.origin,
        data: event.data
      });
      logEl.textContent = JSON.stringify(messages.slice(0, 10), null, 2);
    });
    
    // Initialize
    detectCapabilities();
  </script>
</body>
</html>